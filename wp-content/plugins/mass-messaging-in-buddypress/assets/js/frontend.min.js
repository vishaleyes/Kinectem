jQuery(document).ready(function($){function e(e){return $.grep(e,function(s,n){return n===$.inArray(s,e)})}function s(e){d.prop("disabled",!1),p.html('<div id="message" class="bp-template-notice error"><p>'+e.join("<br />")+"</p></div>").show(),l.show(),c.hide()}function n(e,n,t){var i={action:"get_message_recipients"};i[e]=n,$.post(ajaxurl,i,function(e){e=$.parseJSON(e),e.success?t(e.members):s(e.validation)})}function t(e,s,n,i,r){var u={action:"chunk_send_messages",subject:e,content:s,thread:n,members:i.splice(0,o)},h=r-i.length,g=Math.round(h/r*100);c.find(".information").text("Sending messages ("+h+"/"+r+")"),c.find(".progress-bar").css("width",g+"%"),$.post(ajaxurl,u,function(o){if(o=$.parseJSON(o),o.success)if(i.length>0)setTimeout(function(){t(e,s,n,i,r)},a);else{d.prop("disabled",!1);var u=n&&r>1?"s":"",h=1===r?"1 person":r+" people";p.html('<div id="message" class="bp-template-notice updated"><p>Message'+u+" sent to "+h+".</p></div>").show(),l.show(),c.hide()}else d.prop("disabled",!1),p.html('<div id="message" class="bp-template-notice error"><p>An unknown error occured.</p></div>').show(),l.show(),c.hide()})}function i(e,s,t,o){if(s.length>0){var a=s.splice(0,r);return void n("groups",a,function(n){e=e.concat(n),i(e,s,t,o)})}if(t.length>0){var c=t.splice(0,r);return void n("blogs",c,function(n){e=e.concat(n),i(e,s,t,o)})}o(e)}var r=500,o=100,a=500,c=$("#send_message_progress").hide(),d,p,l;$("#mass_messaging_in_buddypress_checkboxes").on("change",'input[type="checkbox"]',function(){var e=$(this),s="mass_messaging_in_buddypress_select_all",n=e.parent(),t=n.parent().children(),i=t.filter("."+s).children('input[type="checkbox"]'),r=$(this).prop("checked");if(n.hasClass(s))t.children('input[type="checkbox"]').prop("checked",r);else{var o=t.not("."+s),a=o.length,c=0;o.each(function(){var e=$(this),s=e.children('input[type="checkbox"]').prop("checked");return s?void c++:0===c}),c===a?i.prop({indeterminate:!1,checked:!0}):0===c?i.prop({indeterminate:!1,checked:!1}):i.prop({indeterminate:!0,checked:!1})}}),l=$("#send_message_form.mass_messaging_in_buddypress"),l.length>0&&(p=$("#send_message_notice"),d=l.find("#send"),d.on("click",function(n){n.preventDefault();var r=$("#subject").val(),a=$("#message_content").val(),u=!0,h=[];if(""===r&&(u=!1,h.push("No message subject")),""===a&&(u=!1,h.push("No message content")),u){d.prop("disabled",!0),p.hide(),l.hide(),c.html('<div class="information">Getting list of members</div><div class="progress"><div class="progress-bar" style="width: 0%"></div></div>').show();var g=[],m=[],f=[],v=$("#mass_messaging_in_buddypress_list_members"),_=$("#mass_messaging_in_buddypress_list_groups"),b=$("#mass_messaging_in_buddypress_list_blogs");if(v.length>0){var k=v.find("input:checked");g=k.map(function(){return"ignore"!==this.value?this.value:null}).get()}if(_.length>0){var y=_.find("input:checked");m=y.map(function(){return"ignore"!==this.value?this.value:null}).get()}if(b.length>0){var w=b.find("input:checked");f=w.map(function(){return"ignore"!==this.value?this.value:null}).get()}var x=$("#thread").is(":checked");i(g,m,f,function(n){0===n.length?s(["No users selected"]):n.length>o&&x?s(["Sending to more than "+o+" members in a single thread is currently not supported"]):(l.find("#subject, #message_content").val(""),l.find('input[type="checkbox"]').prop("checked",!1),n=e(n),t(r,a,x,n,n.length))})}else s(h);$("body, html").scrollTop(p.offset().top)}))});